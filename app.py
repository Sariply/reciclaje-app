import streamlit as st
import numpy as np
from PIL import Image
from tensorflow.keras.preprocessing import image as keras_image
from tensorflow.keras.models import load_model
from geopy.geocoders import Nominatim
from geopy.distance import geodesic
import folium
from streamlit_folium import st_folium
import os

# üåø Configuraci√≥n general
st.set_page_config(page_title="Clasificador de Reciclaje", layout="wide")

# üåÑ Estilo personalizado
st.markdown("""
<style>
    .stApp {
        background-image: url('https://es.vecteezy.com/foto/2161139-bosque-de-abetos-oscuros-despues-de-la-lluvia');
        background-size: cover !important;
        background-position: center center !important;
        background-repeat: no-repeat !important;
        background-attachment: fixed !important;
        background-color: #0f1f17;
    }
    .main {
        background-color: rgba(15, 31, 23, 0.85);
        padding: 1em;
        border-radius: 10px;
    }
    h1, h2, h3, h4 {
        color: #cde3d2;
    }
    .stButton>button {
        background-color: #6b8e74;
        color: white;
        border-radius: 5px;
        padding: 0.5em 1em;
        margin-bottom: 0.5em;
    }
    .stButton>button:hover {
        background-color: #4f7158;
    }
    .sidebar .sidebar-content {
        background-color: rgba(17, 28, 24, 0.9);
        padding: 1em;
        border-radius: 10px;
    }
</style>
""", unsafe_allow_html=True)

# üß† Cargar modelo
modelo_path = "modelo.h5"
if os.path.exists(modelo_path):
    modelo = load_model(modelo_path)
else:
    st.error(f"‚ùå No se encontr√≥ el modelo `{modelo_path}`. Sube el archivo correctamente antes de ejecutar la app.")
    st.stop()

# ‚ôªÔ∏è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Categor√≠as y descripciones ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
categorias = [
    'Contenedor_urbano_amarillo - Envases',
    'Contenedor_urbano_azul - Papel_y_carton',
    'Contenedor_urbano_verde - Vidrio',
    'Contenedor_urbano_marron - Organico',
    'Contenedor_urbano_gris - Restos',
    'Punto_limpio - Aceite_usado_de_cocina_o_motor',
    'Punto_limpio - Bombillas_y_fluorescentes',
    'Punto_limpio - Cristal_no_reciclable',
    'Punto_limpio - Electrodomesticos',
    'Punto_limpio - Escombros_y_restos_de_obra',
    'Punto_limpio - Juguetes_electronicos',
    'Punto_limpio - Metal_y_chatarra',
    'Punto_limpio - Muebles_y_enseres',
    'Punto_limpio - Pilas_y_baterias',
    'Punto_limpio - Pinturas,_disolventes_y_productos_quimicos',
    'Punto_limpio - Radiografias',
    'Punto_limpio - Raee_residuos_de_aparatos_electronicos',
    'Punto_limpio - Restos_de_poda',
    'Punto_limpio - Ropa_y_calzado',
    'Punto_limpio - Toner_y_cartuchos_de_impresora',
    'Punto_SIGRE - Medicamentos_y_envases'
]

descripciones = {
    'Contenedor_urbano_amarillo - Envases': 'üü° Envases met√°licos, briks y pl√°sticos. Latas, botellas PET, tapones y bolsas limpias.',
    'Contenedor_urbano_azul - Papel_y_carton': 'üîµ Peri√≥dicos, revistas, cajas de cart√≥n, folios y bolsas de papel (sin restos org√°nicos).',
    'Contenedor_urbano_verde - Vidrio': 'üü¢ Botellas, frascos y tarros de vidrio (sin tapas ni restos de cer√°mica).',
    'Contenedor_urbano_marron - Organico': 'üü§ Restos de comida, vegetales, servilletas sucias y residuos biodegradables.',
    'Contenedor_urbano_gris - Restos': '‚ö´ Residuos no reciclables: colillas, compresas, cer√°mica rota y polvo de barrer.',
    'Punto_limpio - Aceite_usado_de_cocina_o_motor': 'üõ¢Ô∏è Lleva el aceite usado en botellas bien cerradas. Nunca lo viertas por el desag√ºe.',
    'Punto_limpio - Bombillas_y_fluorescentes': 'üí° Bombillas LED, fluorescentes y tubos deben entregarse en el punto limpio.',
    'Punto_limpio - Cristal_no_reciclable': 'ü™û Cristales planos, espejos y vidrios de ventanas van al punto limpio. No en el contenedor verde.',
    'Punto_limpio - Electrodomesticos': '‚öôÔ∏è Frigor√≠ficos, lavadoras, microondas y peque√±os aparatos el√©ctricos. Consulta servicio municipal.',
    'Punto_limpio - Escombros_y_restos_de_obra': 'üöß Restos de cemento, ladrillos, azulejos y tierra: solo en puntos autorizados.',
    'Punto_limpio - Juguetes_electronicos': 'üïπÔ∏è Juguetes con pilas o circuitos van al punto limpio como RAEE.',
    'Punto_limpio - Metal_y_chatarra': 'üî© Objetos met√°licos como tuber√≠as, herramientas, herrajes y muebles met√°licos.',
    'Punto_limpio - Muebles_y_enseres': 'ü™ë Sof√°s, camas, mesas, estanter√≠as y muebles voluminosos. Puedes solicitar recogida municipal.',
    'Punto_limpio - Pilas_y_baterias': 'üîã Pilas alcalinas, recargables y bater√≠as de litio. Nunca en contenedores urbanos.',
    'Punto_limpio - Pinturas,_disolventes_y_productos_quimicos': 'üß™ Restos de pintura, sprays, disolventes, insecticidas y productos t√≥xicos.',
    'Punto_limpio - Radiografias': 'ü©ª Radiograf√≠as contienen materiales contaminantes. No deben ir a la basura com√∫n.',
    'Punto_limpio - Raee_residuos_de_aparatos_electronicos': 'üñ•Ô∏è M√≥viles, ordenadores, tablets y cargadores deben llevarse al punto limpio (RAEE).',
    'Punto_limpio - Restos_de_poda': 'üåø Ramas, hojas, c√©sped cortado y restos vegetales grandes van al punto limpio.',
    'Punto_limpio - Ropa_y_calzado': 'üëï Ropa en buen estado puede donarse. Lo dem√°s va a contenedores espec√≠ficos o al punto limpio.',
    'Punto_limpio - Toner_y_cartuchos_de_impresora': 'üñ®Ô∏è Cartuchos de tinta y t√≥ner: contaminantes y reciclables. Nunca en restos.',
    'Punto_SIGRE - Medicamentos_y_envases': 'üíä Medicamentos caducados y sus envases se depositan en puntos SIGRE (en farmacias).'
}

materiales = {
    "Org√°nico": "https://dkv.es/corporativo/blog-360/medioambiente/reciclaje/residuos-organicos",
    "Vidrio": "https://www.ecovidrio.es/reciclaje/cadena-reciclado",
    "Papel y cart√≥n": "https://www.bbva.com/es/sostenibilidad/que-es-el-papel-reciclado-y-cual-es-el-proceso-para-reciclarlo/",
    "Metal": "https://reducereutilizarecicla.org/metal-reciclado/",
    "Pl√°sticos": "https://www.rts.com/es/blog/the-complete-plastics-recycling-process-rts/",
    "Madera": "https://www.gadisa.es/blog/como-se-hace-el-recicleja-de-madera/",
    "Aceite usado": "https://www.sigaus.es",
    "Ropa y calzado": "https://slowfashionnext.com/blog/reciclaje-de-ropa/",
    "Bombillas": "https://www.ambilamp.es",
    "Radiograf√≠as": "https://www.garfellacarsi.com/reciclaje-radiografias/",
    "Tapones": "https://fundacionecoruycan.com/reciclaje-de-tapones/",
    "Corcho": "https://www.bourrasse.com/es/el-reciclaje-del-corcho/",
    "Pilas y bater√≠as": "https://www.ecopilas.es/el-reciclaje/procesos-de-reciclaje-de-pilas/",
    "Medicamentos": "https://www.sigre.es",
    "Qu√≠micos": "https://www.smv.es/como-es-el-proceso-de-reciclaje-de-quimicos/",
    "Restos de poda": "https://www.leanpio.com/es/blog/reciclaje-poda-beneficios"
}

procesos = {
    "Org√°nico": {
        "descripcion": "Se separan y tratan los residuos de origen biol√≥gico para transformarlos en recursos √∫tiles, principalmente compost y abono org√°nico, y se lleva a cabo mediante el compostaje o la digesti√≥n anaer√≥bica.",
        "link": materiales["Org√°nico"]
    },
    "Vidrio": {
        "descripcion": "Se limpia, tritura y funde a m√°s de 1400¬∫ para fabricar nuevos envases.",
        "link": materiales["Vidrio"]
    },
    "Papel y cart√≥n": {
        "descripcion": "Se prensa, trocea, mezcla con agua y seca para formar nuevo papel.",
        "link": materiales["Papel y cart√≥n"]
    },
    "Metal": {
        "descripcion": "Se funde y reutiliza en nuevos objetos met√°licos.",
        "link": materiales["Metal"]
    },
    "Pl√°sticos": {
        "descripcion": "Se separan por tipo, se trituran y se derriten para formar granza. Algunos se reciclan, otros se incineran.",
        "link": materiales["Pl√°sticos"]
    },
    "Madera": {
        "descripcion": "La madera reciclada se usa para hacer tableros aglomerados, compost o biocombustible.",
        "link": materiales["Madera"]
    },
    "Aceite usado": {
        "descripcion": "Se decanta y filtra. Puede usarse en biodi√©sel o como lubricante industrial.",
        "link": materiales["Aceite usado"]
    },
    "Ropa y calzado": {
        "descripcion": "Se clasifican por tipo. Si no se donan, se reciclan como trapos o aislantes textiles.",
        "link": materiales["Ropa y calzado"]
    },
    "Tapones": {
        "descripcion": "Se funden y muchos se usan en proyectos solidarios. Importante separarlos del envase.",
        "link": materiales["Tapones"]
    },
    "Bombillas": {
        "descripcion": "Se recupera la plata de las pel√≠culas. El pl√°stico base tambi√©n puede reutilizarse.",
        "link": materiales["Bombillas"]
    },
    "Corcho": {
        "descripcion": "Se tritura y prensa para crear paneles aislantes o suelas de zapatos. ¬°100‚ÄØ% biodegradable!",
        "link": materiales["Corcho"]
    },
    "Restos de poda": {
        "descripcion": "Poda de grandes cantidades productos vegetales. Se produce compost, biomasa, energ√≠a, viruta y serr√≠n.",
        "link": materiales["Restos de poda"]
    },
    "Medicamentos": {
        "descripcion": "Medicamentos caducados, envases y prospectos, deben ir a Puntos SIGRE en farmacias.",
        "link": materiales["Medicamentos"]
    },
    "Pilas y bater√≠as": {
        "descripcion": "El proceso var√≠a seg√∫n el tipo de bater√≠a, pero generalmente implica trituraci√≥n, separaci√≥n de componentes y recuperaci√≥n de metales como zinc, hierro, n√≠quel, cadmio o litio.",
        "link": materiales["Pilas y bater√≠as"]
    },
    "Qu√≠micos": {
        "descripcion": "Pinturas, disolventes y productos t√≥xicos se neutralizan o almacenan en dep√≥sitos seguros.",
        "link": materiales["Qu√≠micos"]
    },
     "Radiograf√≠as": {
        "descripcion": "Siguen un proceso para recuperar materiales como la plata y para que los datos privados se destruyan con seguridad.",
        "link": materiales["Radiograf√≠as"]
    }, 
}

# Inicializar session_state si es necesario
if "material_elegido" not in st.session_state:
    st.session_state["material_elegido"] = None

for material in materiales:
    if st.sidebar.button(f"üîé {material}"):
        st.session_state["material_elegido"] = material

# Sidebar izquierda
st.sidebar.header("üß† C√≥mo se recicla")
st.sidebar.markdown("""<div style="background-color: rgba(60, 83, 70, 0.3); padding: 8px; border-radius: 10px; margin-bottom: 1em;">üìö Aprende sobre el reciclaje seleccionando un material para ver enlaces educativos y procesos.</div>""", unsafe_allow_html=True)

for material in materiales:
    if st.sidebar.button(f"üîé {material}"):
        st.session_state["material_elegido"] = material

        
# Columnas
col1, col2, col3 = st.columns([1, 2, 1])

# Proceso de reciclaje (col1)
with col1:
    st.title("üß™ Proceso de reciclaje")
    material_elegido = st.session_state.get("material_elegido")
    if material_elegido in procesos:
        info = procesos[material_elegido]
        st.markdown(f"""
        <div style="background-color: rgba(60, 83, 70, 0.4); border-left: 6px solid #a2cfa5; padding: 10px; border-radius: 10px; margin-bottom: 20px; box-shadow: 2px 2px 6px rgba(0,0,0,0.2);">
            <h3 style="color:#d5eadd">üìã Material: {material_elegido}</h3>
            <p style="color:#e0e0e0; font-size: 1.05em;">{info["descripcion"]}</p>
            <a href="{info["link"]}" target="_blank" style="color:#c1e9d8; font-weight:bold;">üëâ M√°s informaci√≥n oficial</a>
        </div>
        """, unsafe_allow_html=True)

# Clasificador de reciclaje (col2)
with col2:
    st.title("‚ôªÔ∏è Clasificador de Reciclaje Inteligente")
    imagen_subida = st.file_uploader("üì∏ Sube tu imagen aqu√≠", type=["jpg", "jpeg", "png"])

    if imagen_subida is not None:
        try:
            img = Image.open(imagen_subida).convert("RGB")
            img = img.resize((150, 150))
            img_array = keras_image.img_to_array(img) / 255.0
            img_array = np.expand_dims(img_array, axis=0)

            prediccion = modelo.predict(img_array)
            if prediccion.shape[1] != len(categorias):
                st.error(f"üö´ El modelo devuelve {prediccion.shape[1]} clases, pero hay {len(categorias)} definidas.")
            else:
                top_indices = np.argsort(prediccion[0])[::-1][:2]
                i1, i2 = top_indices
                confianza_principal = prediccion[0][i1]
                clase_principal = categorias[i1]
                descripcion_principal = descripciones.get(clase_principal, "‚ÑπÔ∏è (Sin descripci√≥n disponible)")

                st.success(f"‚úÖ Categor√≠a recomendada: **{clase_principal.replace('_', ' ').title()}**")
                st.write(descripcion_principal)
                st.write(f"üîí Confianza: **{confianza_principal:.2%}**")
                st.image(img, caption="Imagen subida", use_container_width=True)

                confianza_secundaria = prediccion[0][i2]
                if confianza_secundaria > confianza_principal - 0.10:
                    clase_secundaria = categorias[i2]
                    descripcion_secundaria = descripciones.get(clase_secundaria, "‚ÑπÔ∏è (Sin descripci√≥n disponible)")
                    st.warning(f"ü§î Alternativa posible: **{clase_secundaria.replace('_', ' ').title()}**")
                    st.write(descripcion_secundaria)
                    st.write(f"üìä Confianza alternativa: **{confianza_secundaria:.2%}**")
        except Exception as e:
            st.error("üö® Error al procesar la imagen.")
            st.write(f"üõ†Ô∏è Detalle t√©cnico: `{e}`")
    else:
        st.info("üìé Sube una imagen para comenzar el proceso de clasificaci√≥n.")

# Geolocalizaci√≥n (col3)
with col3:
    st.markdown("""
    <div style="background-color: rgba(60, 83, 70, 0.4); border-left: 6px solid #a2cfa5; padding: 15px; border-radius: 10px; margin-bottom: 25px; box-shadow: 2px 2px 6px rgba(0,0,0,0.2);">
        <h4 style="color:#d5eadd">üìç Encuentra tu punto limpio</h4>
        <p style="color:#e0e0e0; font-size: 1.05em;">
        Escribe tu ciudad o direcci√≥n para localizar tu ubicaci√≥n y acceder a los puntos limpios cercanos.
        </p>
    </div>
    """, unsafe_allow_html=True)

    direccion = st.text_input("üîé Introduce tu ubicaci√≥n")

    if direccion:
        try:
            geolocator = Nominatim(user_agent="reciclaje_app")
            ubicacion = geolocator.geocode(direccion, timeout=10)

            if ubicacion:
                st.success(f"üìç Ubicaci√≥n detectada: {ubicacion.address}")
                query = f"punto limpio cerca de {ubicacion.address}"
                url_google_maps = f"https://www.google.com/maps/search/{query.replace(' ', '+')}"

                st.markdown(f"""
                <div style="margin-top:15px; text-align: center;">
                    <a href="{url_google_maps}" target="_blank" style="text-decoration: none;">
                        <div style="background-color: #6b8e74; color: white; padding: 10px 20px; border-radius: 6px; font-size: 16px; font-weight: bold; box-shadow: 2px 2px 6px rgba(0,0,0,0.3);">
                            üó∫Ô∏è Abrir mapa completo
                        </div>
                    </a>
                </div>
                """, unsafe_allow_html=True)

                mapa = folium.Map(location=[ubicacion.latitude, ubicacion.longitude], zoom_start=13)
                folium.Marker(
                    [ubicacion.latitude, ubicacion.longitude],
                    popup="Tu ubicaci√≥n",
                    icon=folium.Icon(color="green")
                ).add_to(mapa)

                st_folium(mapa, width=300, height=250)
            else:
                st.warning("‚ùå No se pudo encontrar esa ubicaci√≥n. Intenta con una direcci√≥n m√°s precisa.")
        except Exception as e:
            st.error("üö® Error al conectar con el servicio de geolocalizaci√≥n.")
            st.write(f"üõ†Ô∏è Detalle t√©cnico: `{e}`")
